name: Build & Test (Linux + Windows)

on:
  # 1) Every PR that targets master – first open, new commits ("synchronize"),
  #    or being reopened – will fire pull_request by default.
  pull_request:
    branches: [ master ]        #  ← change to main if that’s your default

  # 2) Any commit pushed **directly to master** (including the merge-commit
  #    created when a PR is merged with the GitHub UI).
  push:
    branches: [ master ]        #  ← same default branch

jobs:
  build:
    strategy:
      matrix:
        include:
          # ── Linux ────────────────────────────────────────────────────────
          - os: ubuntu-22.04
            cfg:   linux-release     # configure preset
            build: linux-build       # build preset
            test:  linux-test        # test preset
            isLinux: true
          # ── Windows ──────────────────────────────────────────────────────
          - os: windows-2022
            cfg:   windows-release
            build: windows-build
            test:  windows-test
            isLinux: false

    runs-on: ${{ matrix.os }}

    steps:
      # 1) ───── Source checkout ─────────────────────────────────────────────
      - uses: actions/checkout@v4

      # 2) ───── OS-level dependencies ───────────────────────────────────────
      - name: Install packages (apt)
        if: matrix.isLinux
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang ninja-build cmake build-essential \
            libxmu-dev libxi-dev libxinerama-dev libxrandr-dev \
            libxcursor-dev libudev-dev libopenal-dev unixodbc-dev \
            libgl1-mesa-dev libxxf86vm-dev zlib1g-dev

      - name: Set up MSVC env
        if: matrix.os == 'windows-2022'
        uses: ilammy/msvc-dev-cmd@v1
        with: { arch: x64 }

      - name: Verify Ninja is on PATH
        run: ninja --version

      # 3) ───── Unpack pre-built Esenthel artefacts ─────────────────────────
      - name: Unzip Engine files (Linux)
        if: matrix.isLinux
        shell: bash
        run: |
          unzip -q assets/Engine.zip      -d assets
          unzip -q third_party/EE/Engine.zip -d third_party/EE

      - name: Unzip Engine files (Windows)
        if: matrix.os == 'windows-2022'
        shell: pwsh
        run: |
          Expand-Archive -Path assets/Engine.zip -DestinationPath assets -Force
          Get-ChildItem -Path third_party/EE -Filter '*.zip' |
            ForEach-Object { Expand-Archive -Path $_.FullName -DestinationPath third_party/EE -Force }

      # 4) ───── Configure, build & test via presets ─────────────────────────
      - name: Configure
        run: cmake --preset ${{ matrix.cfg }}

      - name: Build
        run: cmake --build --preset ${{ matrix.build }}

      - name: Run unit tests
        run: ctest --test-dir out/build/${{ matrix.cfg }} --output-on-failure

      # 5) ───── Upload the resulting executable ─────────────────────────────
      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: BasicAppCmake-${{ matrix.os }}
          path: |
            out/build/${{ matrix.cfg }}/apps/client/client${{ runner.os == 'Windows' && '.exe' || '' }}
            out/build/${{ matrix.cfg }}/apps/server/server${{ runner.os == 'Windows' && '.exe' || '' }}
